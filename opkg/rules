#!/bin/sh
set -e 

PACKAGE=mosh

case "$1" in
  build)
    if [ \! -f configure ]; then
      ./autogen.sh
    fi
    NCURSES_INCLUDE=~/droid/$BASEDIR/include/ncurses/
    GENERIC_INCLUDE=~/droid/$BASEDIR/include/
    LIBDIR=~/droid/$BASEDIR/lib/

    export protobuf_LIBS="-lprotobuf"
    export protobuf_CFLAGS=" "

    export OPENSSL_CFLAGS=-I${HOME}/droid/$BASEDIR/include/openssl/
    export OPENSSL_LIBS="-lssl -lcrypto"
    export USE_STATIC_GNUSTL=1
    ./configure --host=arm-linux --prefix=/$BASEDIR \
      CC=agcc CXX=ag++ \
      CPPFLAGS="-I$NCURSES_INCLUDE -I$GENERIC_INCLUDE" \
      LDFLAGS="-L$LIBDIR"
    # -lpthread comes from the cross-compiling machine's library requirements
    # -lutil is needed for forkpty on the cross-compiling machine
    # -fPIE/-pie breaks android's dynamic linker
    sed -i -e 's/^protobuf_LIBS = -lprotobuf -lz -lpthread/protobuf_LIBS = -lprotobuf -lz/' \
      -e 's/^mosh_server_LDADD = $(LDADD) -lutil/mosh_server_LDADD = $(LDADD)/' \
      -e 's/^mosh_LDADD = $(LDADD) -lutil/mosh_LDADD = $(LDADD)/' \
      -e 's/^\(HARDEN_CFLAGS = .*\)-fPIE\(.*\)/\1 \2/' \
      -e 's/^\(HARDEN_LDFLAGS = .*\)-pie\(.*\)/\1 \2/' \
      src/frontend/Makefile
    make
    ;;

  install)
    DESTDIR=~/tmp/$PACKAGE
    rm -rf $DESTDIR
    mkdir -p $DESTDIR
    make install DESTDIR=$DESTDIR
    install -m755 src/frontend/mosh $DESTDIR/$BASEDIR/bin/
    astrip $DESTDIR/$BASEDIR/bin/mosh-client
    ;;
    
  clean)
    make clean
    ;;

  *)
    echo unknown argument $1
    ;;
esac
